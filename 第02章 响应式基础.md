# è®¾è®¡æ¨¡å¼

Vue çš„è®¾è®¡çµæ„Ÿä¸»è¦æ¥æºäº MVVMï¼ˆ**M**odel-**V**iew-**V**iew**M**odelï¼‰ æ¨¡å‹ï¼Œå› æ­¤åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå¸¸ç”¨ `vm` è¡¨ç¤ºç»„ä»¶å®ä¾‹ã€‚

## MVC

MVCï¼ˆ**M**odel-**V**iew-**C**ontrollerï¼‰æ˜¯ä¸€ç§ç»å…¸çš„è®¾è®¡æ¨¡å¼ï¼Œå¹¿æ³›åº”ç”¨äºä¼ ç»Ÿ Web å¼€å‘ä¸­ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†åº”ç”¨ç¨‹åºåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š

1. **Modelï¼ˆæ¨¡å‹ï¼‰**ï¼šè´Ÿè´£ç®¡ç†åº”ç”¨ç¨‹åºçš„æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ã€‚å®ƒç‹¬ç«‹äºç”¨æˆ·ç•Œé¢ï¼Œä¸“æ³¨äºæ•°æ®çš„è·å–ã€å­˜å‚¨å’Œå¤„ç†ã€‚
2. **Viewï¼ˆè§†å›¾ï¼‰**ï¼šè´Ÿè´£æ•°æ®çš„å±•ç¤ºã€‚å®ƒæ˜¯ç”¨æˆ·ç•Œé¢çš„å¯è§†éƒ¨åˆ†ï¼Œé€šå¸¸é€šè¿‡æ¨¡æ¿æˆ– UI æ§ä»¶å‘ˆç°æ•°æ®ã€‚
3. **Controllerï¼ˆæ§åˆ¶å™¨ï¼‰**ï¼šä½œä¸ºæ¨¡å‹å’Œè§†å›¾ä¹‹é—´çš„æ¡¥æ¢ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·è¾“å…¥å¹¶æ›´æ–°æ¨¡å‹å’Œè§†å›¾ã€‚

MVC çš„ç›®æ ‡æ˜¯å®ç°æ¨¡å—åŒ–ã€å¯ç»´æŠ¤å’Œå¯æµ‹è¯•çš„åº”ç”¨ç¨‹åºã€‚ç„¶è€Œï¼Œåœ¨ç°ä»£å‰ç«¯å¼€å‘ä¸­ï¼ŒMVC é€æ¸è¢«æ›´è½»é‡çº§çš„æ¨¡å¼ï¼ˆå¦‚ MVVMï¼‰å–ä»£ã€‚

## MVVM

MVVM æ˜¯ MVC çš„æ”¹è¿›ç‰ˆæœ¬ï¼Œç‰¹åˆ«é€‚ç”¨äºç°ä»£å‰ç«¯å¼€å‘ã€‚

![](IMGS/mvvm.png)

å®ƒå°†åº”ç”¨ç¨‹åºåˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š

1. **Modelï¼ˆæ¨¡å‹ï¼‰**ï¼šä¸ MVC ä¸­çš„æ¨¡å‹ç±»ä¼¼ï¼Œè´Ÿè´£ç®¡ç†æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ã€‚
2. **Viewï¼ˆè§†å›¾ï¼‰**ï¼šç”¨æˆ·ç•Œé¢çš„å¯è§†éƒ¨åˆ†ï¼Œè´Ÿè´£å±•ç¤ºæ•°æ®ã€‚
3. **ViewModelï¼ˆè§†å›¾æ¨¡å‹ï¼‰**ï¼šè¿æ¥æ¨¡å‹å’Œè§†å›¾ï¼Œè´Ÿè´£å°†æ¨¡å‹æ•°æ®è½¬æ¢ä¸ºè§†å›¾å¯ç”¨çš„å½¢å¼ï¼Œå¹¶æä¾›æ•°æ®ç»‘å®šå’Œäº‹ä»¶å¤„ç†åŠŸèƒ½ã€‚

MVVM çš„æ ¸å¿ƒç‰¹æ€§æ˜¯ **æ•°æ®ç»‘å®š** å’Œ **å‘½ä»¤ç»‘å®š**ã€‚æ•°æ®ç»‘å®šä½¿å¾—è§†å›¾å’Œè§†å›¾æ¨¡å‹ä¹‹é—´çš„æ•°æ®èƒ½å¤Ÿè‡ªåŠ¨åŒæ­¥ï¼Œè€Œå‘½ä»¤ç»‘å®šåˆ™å…è®¸è§†å›¾æ¨¡å‹å¤„ç†ç”¨æˆ·äº¤äº’ã€‚

é€šè¿‡ MVVMï¼Œå¼€å‘è€…èƒ½å¤Ÿæ›´å¥½åœ°åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œå®ç°è§†å›¾ä¸ä¸šåŠ¡é€»è¾‘çš„è§£è€¦ï¼Œä»è€Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

# å“åº”å¼æ¦‚è¿°

Vue çš„å“åº”å¼ç³»ç»Ÿæ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå…è®¸å¼€å‘è€…å°†æ•°æ®ç»‘å®šåˆ°è§†å›¾ä¸Šï¼Œå¹¶åœ¨æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°è§†å›¾ã€‚

ä½ å¯ä»¥é€šè¿‡åŒèŠ±æ‹¬å·æ¥å°†æ•°æ®ç»‘å®šåœ¨è§†å›¾ä¸Šï¼Œæ¯”å¦‚ï¼š

```vue
<script setup lang="ts">
    
// -- å®šä¹‰å˜é‡
let count = 0;
    
</script>

<template>
  <!-- ç»‘å®šæ•°æ® -->
  <div>countï¼š{{ count }}</div>
</template>
```

é¡µé¢è¾“å‡ºï¼š`countï¼š0`ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨æ¨¡æ¿ template ä¸­å®šä¹‰ä¸€ä¸ªæŒ‰é’®å°è¯•ä¿®æ”¹ `count` çš„å€¼ï¼Œçœ‹çœ‹è§†å›¾æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼š

```vue
<script setup lang="ts">
// -- å®šä¹‰å˜é‡
let count = 0;

// -- äº‹ä»¶å¤„ç†å‡½æ•°
const increment = () => {
  count++; 
};
</script>

<template>
  <!-- ç»‘å®šæ•°æ® -->
  <div>countï¼š{{ count }}</div>
  <button type="button" @click="increment">increment</button>
</template>
```

ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`@click` è¡¨ç¤ºä¸ºæŒ‰é’® `button` æ·»åŠ ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œäº‹ä»¶å¤„ç†å‡½æ•°ä¸ºï¼š`increment`ï¼Œåœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è®© `count` å˜é‡è‡ªå¢ï¼Œç‚¹å‡»æŒ‰é’®ï¼Œå¯ä»¥å‘ç°ï¼Œè§†å›¾å¹¶æ²¡æœ‰æ›´æ–°ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å®šä¹‰çš„å˜é‡ `count` å¹¶éæ˜¯å“åº”å¼çš„ï¼ˆå°½ç®¡ä½ å¯ä»¥å°†å…¶å‘ˆç°åœ¨è§†å›¾ä¸Šï¼Œä½†å˜é‡ `count` å¹¶æ²¡æœ‰åŠ å…¥å“åº”å¼ç³»ç»Ÿä¸­ï¼‰ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹åœ¨ vue ä¸­å“åº”å¼ç›¸å…³çš„ API

# å“åº”å¼ï¼šæ ¸å¿ƒ

## `ref()`

 [`ref()`](https://cn.vuejs.org/api/reactivity-core.html#ref)  ç”¨äºåˆ›å»ºé€‚ç”¨äº **ä»»ä½•å€¼ç±»å‹** çš„å“åº”å¼å¼•ç”¨ã€‚å®ƒå°†å€¼åŒ…è£…ä¸ºä¸€ä¸ªå¸¦æœ‰ `.value` å±æ€§çš„å¯¹è±¡ã€‚

é€‚ç”¨äº**åŸºæœ¬ç±»å‹**ï¼ˆå¦‚ `number`ã€`string`ã€`boolean`ï¼‰ï¼Œä¹Ÿå¯åŒ…è£…å¯¹è±¡æˆ–æ•°ç»„ã€‚

å†…éƒ¨ä¼šå°†å¯¹è±¡ç±»å‹è‡ªåŠ¨è½¬ä¸º `reactive` ä»£ç†ã€‚

```vue
<script setup lang="ts">
import { ref } from "vue";
const count = ref(0);
const onIncrement = () => count.value++;
</script>

<template>
  <div class="flex space-x-4">
    <!-- åœ¨ JavaScript ä¸­éœ€è¦ .value -->
    <button class="w-20 leading-10 bg-gray-200" @click="onIncrement">{{ count }}</button>
    <!-- åœ¨æ¨¡æ¿ä¸­åˆ™ä¸éœ€è¦ .value -->
    <button class="w-20 leading-10 bg-gray-200" @click="count++">{{ count }}</button>
  </div>
</template>

```

ç‚¹å‡»æŒ‰é’®ï¼Œå¯ä»¥å‘ç°ï¼Œ`count` å€¼æˆåŠŸæ›´æ–°ã€‚

`ref()` è¿˜å¯ä»¥ç”¨äºè·å– DOM å…ƒç´ ï¼š

```vue
<script setup lang="ts">
import { onMounted, ref } from "vue";

const dom = ref<HTMLDivElement>();
onMounted(() => console.log(dom.value?.textContent)); // Hello, Vue.js!
</script>

<template>
  <div ref="dom">Hello, Vue.js!</div>
</template>
```

## `reactive()`

 [`reactive()`](https://cn.vuejs.org/api/reactivity-core.html#reactive)  ç”¨äºåˆ›å»ºå“åº”å¼å¯¹è±¡æˆ–æ•°ç»„ã€‚å®ƒåŸºäº JavaScript çš„ `Proxy` å®ç°ï¼Œèƒ½å¤Ÿè¿½è¸ªå¯¹è±¡çš„å±æ€§è®¿é—®å’Œä¿®æ”¹ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡çš„å“åº”å¼ä»£ç†ã€‚

```vue
<script setup lang="ts">
import { reactive } from "vue";

interface IState {
  count: number;
}
const state = reactive<IState>({ count: 0 });
</script>

<template>
  <button @click="state.count++">{{ state.count }}</button>
</template>
```

**`reactive()`** çš„å±€é™æ€§ï¼š

1. ä»…é€‚ç”¨äºå¯¹è±¡ç±»å‹ï¼Œä¸é€‚ç”¨äºåŸå§‹ç±»å‹ï¼ˆå¦‚ `string`ã€`number`ï¼‰ã€‚
2. è§£æ„å“åº”å¼å¯¹è±¡æ—¶ï¼Œè§£æ„å‡ºçš„å±æ€§ä¼šå¤±å»å“åº”æ€§ã€‚
3. **ä¸å¯é‡æ–°èµ‹å€¼**ï¼ˆåªèƒ½ä¿®æ”¹å†…éƒ¨å±æ€§ï¼‰ã€‚

# å“åº”å¼ï¼šå·¥å…·

## `isRef()`

æ£€æŸ¥æŸä¸ªå€¼æ˜¯å¦ä¸º ref

```vue
<script setup lang="ts">
import { isRef, reactive, ref } from "vue";

const name = ref("å¼ ä¸‰");
const age = 20;
const obj = reactive({ name: "æå››" });

console.log(isRef(name), isRef(age), isRef(obj)); // true false false
</script>
```

## `unref()`

å¦‚æœå‚æ•°æ˜¯ refï¼Œåˆ™è¿”å›å†…éƒ¨å€¼ï¼Œå¦åˆ™è¿”å›å‚æ•°æœ¬èº«

è¿™æ˜¯ `val = isRef(val) ? val.value : val` è®¡ç®—çš„ä¸€ä¸ªè¯­æ³•ç³–ã€‚

```vue
<script setup lang="ts">
import { ref, unref } from "vue";

const name = ref("å¼ ä¸‰");
const value = unref(name);
console.log(value); // å¼ ä¸‰
</script>
```

## `toRef()`

`toRef` æ˜¯ä¸€ä¸ªç”¨äº**åˆ›å»ºå“åº”å¼å¼•ç”¨**çš„å·¥å…·å‡½æ•°ï¼Œå®ƒèƒ½å¤Ÿå°†å“åº”å¼å¯¹è±¡ï¼ˆå¦‚ `reactive` ç”Ÿæˆçš„å¯¹è±¡ï¼‰çš„æŸä¸ªå±æ€§è½¬æ¢ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ `ref` å¯¹è±¡ï¼ŒåŒæ—¶ä¿æŒä¸åŸå§‹å±æ€§çš„**åŒå‘å“åº”å¼è¿æ¥**ã€‚å®ƒæœ‰ä¸¤ç§ä¸»è¦ç”¨æ³•ï¼š

1ï¼‰**åŸºæœ¬åŠŸèƒ½**

`toRef()` å¯ä»¥æŠŠä¸‰ç§ä¸œè¥¿è½¬æ¢æˆ refï¼š

- æ™®é€šå€¼ â†’ å˜æˆæ™®é€š refï¼ˆå’Œ `ref()` ä¸€æ ·ï¼‰
- å·²æœ‰çš„ ref â†’ ç›´æ¥è¿”å›è¿™ä¸ª ref
- getter å‡½æ•° â†’ å˜æˆåªè¯» refï¼ˆ3.3+æ–°åŠŸèƒ½ï¼‰

```js
// æ™®é€šå€¼ â†’ ref
const a = toRef(1); // ç­‰åŒäº ref(1)

// å·²æœ‰ ref â†’ ç›´æ¥è¿”å›
const b = ref(2);
const c = toRef(b); // c å°±æ˜¯ b æœ¬èº«

// getter å‡½æ•° â†’ åªè¯» ref
const d = toRef(() => props.count); // åªè¯»ï¼Œä¸èƒ½ä¿®æ”¹
```

2ï¼‰**å¯¹è±¡å±æ€§è½¬æ¢ï¼ˆæœ€å¸¸ç”¨ï¼‰**

`toRef()` æœ€é‡è¦çš„åŠŸèƒ½æ˜¯å¯ä»¥æŠŠå“åº”å¼å¯¹è±¡çš„æŸä¸ªå±æ€§å˜æˆ refï¼Œå¹¶ä¸”ä¿æŒåŒå‘ç»‘å®šï¼š

```js
const state = reactive({ count: 0 })

// æŠŠ state.count å˜æˆ ref
const countRef = toRef(state, 'count')

// ä¿®æ”¹ ref ä¼šæ›´æ–°åŸå¯¹è±¡
countRef.value++ 
console.log(state.count) // è¾“å‡º 1

// ä¿®æ”¹åŸå¯¹è±¡ä¹Ÿä¼šæ›´æ–° ref
state.count++
console.log(countRef.value) // è¾“å‡º 2
```

ğŸ¤” **ä¸æ™®é€š `ref()` çš„åŒºåˆ«ï¼Ÿ**

```js
// é”™è¯¯åšæ³•ï¼šè¿™æ ·ä¸ä¼šä¿æŒåŒæ­¥
const badRef = ref(state.count) // åªæ˜¯å¤åˆ¶äº†å½“å‰å€¼

// æ­£ç¡®åšæ³•ï¼šç”¨ toRef ä¿æŒåŒæ­¥
const goodRef = toRef(state, 'count') 
```

ğŸ¤” **ä½¿ç”¨åœºæ™¯**

1. **ä¼ é€’ props ç»™ç»„åˆå¼å‡½æ•°**ï¼š

   ```js
   const props = defineProps({ title: String })
   
   // ä¿æŒå“åº”å¼ä¼ é€’
   useSomeFeature(toRef(props, 'title'))
   ```

2. **å¤„ç†å¯èƒ½ä¸å­˜åœ¨çš„å±æ€§**ï¼š

   ```js
   // å³ä½¿ state.optional ä¸å­˜åœ¨ä¹Ÿä¼šåˆ›å»º ref
   const optRef = toRef(state, 'optional')
   ```

## `toRefs()`

`toRefs()` å°†å“åº”å¼å¯¹è±¡è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡ï¼Œå…¶ä¸­æ¯ä¸ªå±æ€§éƒ½æ˜¯æŒ‡å‘åŸå§‹å¯¹è±¡ç›¸åº”å±æ€§çš„ `ref`ã€‚

```vue
<script setup lang="ts">
// -- imports
import { reactive, toRefs } from 'vue';

// -- Define State Props
interface IState {
  name: string;
  age: number;
}
// -- state
const state = reactive<IState>({
  name: 'Li-HONGYAO',
  age: 18,
});

/**
stateAsRefs: {
  name: Ref<string>,
  age: Ref<number>
}*/
const stateAsRefs = toRefs(state);

// ref å’ŒåŸå§‹ property å·²ç»è¿æ¥èµ·æ¥äº†
state.age++;
console.log(stateAsRefs.age.value); // 19

stateAsRefs.age.value++;
console.log(state.age); // 20
</script>
```

å°å¦™æ‹›ï¼šåœ¨ä¸€ä¸ªé¡µé¢ä¸­ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªçŠ¶æ€ï¼ˆ`state`ï¼‰ï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ã€ç™»å½•çŠ¶æ€ç­‰ç­‰ï¼Œä½ å¯èƒ½ä¼šå®šä¹‰å¤šä¸ª `ref` æˆ–è€… `reactive` å˜é‡æ¥ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œåœ¨ vue2.xï¼Œå±æ€§ä¸€èˆ¬ç»Ÿä¸€å®šä¹‰åœ¨ `data` é€‰é¡¹ä¸­é›†ä¸­ç®¡ç†ï¼Œå¦‚æœä½ ä¹Ÿæƒ³å°†ä¸€ä¸ªé¡µé¢çš„çŠ¶æ€ç»Ÿä¸€å®šä¹‰åœ¨ä¸€ä¸ª `state` å˜é‡ä¸­ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š

```typescript
const state = reactive({
  loginStatus: 0,
  user: {
    name: 'å¼ ä¸‰',
    job: 'å‰ç«¯å·¥ç¨‹å¸ˆ',
    address: 'æˆéƒ½å¸‚é«˜æ–°åŒº',
  },
});
```

ç„¶ååœ¨æ¨¡æ¿ä¸­è®¿é—®ï¼š

```vue
<div>loginStatusï¼š{{ state.loginStatus ? 'å·²ç™»å½•' : 'æœªç™»å½•' }}</div>
<div>Nameï¼š{{ state.user.name }}</div>
<div>jobï¼š{{ state.user.job }}</div>
<div>addressï¼š{{ state.user.job }}</div>
```

ä½†æ˜¯ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œæ¯æ¬¡è®¿é—®å±æ€§éƒ½éœ€è¦é€šè¿‡ `state.xxx`ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡æŸç§å½¢å¼ç›´æ¥è®¿é—®å±æ€§å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šæœ‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `toRefs` æ¥æ”¹é€ ã€‚

```typescript
const { loginStatus, user } = toRefs(state);
```

ç„¶åå°±å¯ä»¥åœ¨æ¨¡æ¿ä¸­ç›´æ¥è®¿é—® `loginStatus` å’Œ `user` äº†ã€‚

## `isProxy()`

æ£€æŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯ç”± [`reactive()`](https://cn.vuejs.org/api/reactivity-core.html#reactive)ã€[`readonly()`](https://cn.vuejs.org/api/reactivity-core.html#readonly)ã€[`shallowReactive()`](https://cn.vuejs.org/api/reactivity-advanced.html#shallowreactive) æˆ– [`shallowReadonly()`](https://cn.vuejs.org/api/reactivity-advanced.html#shallowreadonly) åˆ›å»ºçš„ä»£ç†ã€‚

## `isReactive`

æ£€æŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯ç”± [`reactive()`](https://cn.vuejs.org/api/reactivity-core.html#reactive) æˆ– [`shallowReactive()`](https://cn.vuejs.org/api/reactivity-advanced.html#shallowreactive) åˆ›å»ºçš„ä»£ç†ã€‚

## `isReadonly()`

æ£€æŸ¥å¯¹è±¡æ˜¯å¦æ˜¯ [`readonly()`](https://cn.vuejs.org/api/reactivity-core.html#readonly) åˆ›å»ºçš„ä»£ç†ã€‚

# æ‰©å±•ï¼šå“åº”å¼åŸç†

Vue çš„å“åº”å¼ç³»ç»Ÿæ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒé€šè¿‡æ•°æ®åŠ«æŒå’Œä¾èµ–è¿½è¸ªæœºåˆ¶ï¼Œå®ç°äº†æ•°æ®ä¸è§†å›¾çš„è‡ªåŠ¨åŒæ­¥ã€‚Vue 2.x å’Œ Vue 3.x åœ¨å“åº”å¼åŸç†çš„å®ç°ä¸Šæœ‰æ‰€ä¸åŒï¼Œä¸‹é¢æˆ‘ä»¬å°†åˆ†åˆ«æ¢è®¨å®ƒä»¬çš„å®ç°æœºåˆ¶ã€‚

## @2.x

Vue 2.x çš„å“åº”å¼ç³»ç»ŸåŸºäº **æ•°æ®åŠ«æŒ** å’Œ **è§‚å¯Ÿè€…æ¨¡å¼** å®ç°ï¼Œä¸»è¦é€šè¿‡ `Object.defineProperty` æ¥ç›‘å¬æ•°æ®çš„å˜åŒ–ã€‚

**å®ç°æœºåˆ¶**

1. **æ•°æ®åŠ«æŒ**ï¼š
   - åœ¨ Vue å®ä¾‹åˆå§‹åŒ–æ—¶ï¼ŒVue ä¼šéå† `data` å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œå¹¶ä½¿ç”¨ `Object.defineProperty` å°†è¿™äº›å±æ€§è½¬æ¢ä¸º `getter` å’Œ `setter`ã€‚
   - å½“è®¿é—®å±æ€§æ—¶ï¼Œ`getter` ä¼šè¢«è§¦å‘ï¼ŒVue ä¼šå°†å½“å‰çš„ `Watcher` å¯¹è±¡æ·»åŠ åˆ°ä¾èµ–åˆ—è¡¨ä¸­ï¼Œå»ºç«‹å±æ€§ä¸ `Watcher` çš„å…³è”ã€‚
   - å½“ä¿®æ”¹å±æ€§æ—¶ï¼Œ`setter` ä¼šè¢«è§¦å‘ï¼ŒVue ä¼šé€šçŸ¥ä¾èµ–åˆ—è¡¨ä¸­çš„æ‰€æœ‰ `Watcher` å¯¹è±¡ï¼Œè§¦å‘è§†å›¾æ›´æ–°ã€‚
2. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼š
   - `Watcher` æ˜¯ Vue ä¸­çš„è§‚å¯Ÿè€…ï¼Œè´Ÿè´£æ”¶é›†ä¾èµ–å’Œè§¦å‘æ›´æ–°ã€‚æ¯ä¸ªå“åº”å¼å±æ€§éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„`Watcher`ï¼Œç”¨äºå­˜å‚¨ä¸è¯¥å±æ€§ç›¸å…³çš„ä¾èµ–ã€‚
   - å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ`Watcher` ä¼šæ‰§è¡Œæ›´æ–°æ“ä½œï¼Œç¡®ä¿è§†å›¾ä¸æ•°æ®ä¿æŒåŒæ­¥ã€‚

**å±€é™æ€§**

1. **æ·±åº¦ç›‘å¬**ï¼šéœ€è¦å¯¹å¯¹è±¡è¿›è¡Œé€’å½’éå†ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§ã€‚
2. **æ–°å¢/åˆ é™¤å±æ€§**ï¼šæ— æ³•ç›´æ¥ç›‘å¬ï¼Œéœ€è¦ä½¿ç”¨ `Vue.set` å’Œ `Vue.delete` æ–¹æ³•ã€‚*ï¼ˆæ‰€ä»¥å¼€å‘ä¸­éœ€è¦ä½¿ç”¨ `Vue.set` å’Œ `Vue.delete` è¿™ä¸¤ä¸ª API æ¥å¢åˆ  data çš„å±æ€§ï¼‰*
3. **æ•°ç»„ç›‘å¬**ï¼šæ— æ³•åŸç”Ÿç›‘å¬æ•°ç»„çš„å˜åŒ–ï¼Œéœ€è¦å¯¹æ•°ç»„æ–¹æ³•è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚

## @3.x

Vue 3.x ä½¿ç”¨ `Proxy` æ›¿ä»£ `Object.defineProperty`ï¼Œè§£å†³äº† Vue 2.x çš„å±€é™æ€§ï¼Œå¹¶æä¾›äº†æ›´é«˜æ•ˆçš„å“åº”å¼ç³»ç»Ÿã€‚

**å®ç°æœºåˆ¶**

1. **Proxy ä»£ç†**ï¼š
   - Vue 3.x ä½¿ç”¨ `reactive` å‡½æ•°å°†æ•°æ®å¯¹è±¡è½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡ã€‚`reactive` å†…éƒ¨åŸºäº `Proxy` å®ç°ï¼Œèƒ½å¤Ÿæ‹¦æˆªå¯¹è±¡çš„è¯»å–å’Œä¿®æ”¹æ“ä½œã€‚
   - å½“è®¿é—®å“åº”å¼å¯¹è±¡çš„å±æ€§æ—¶ï¼Œ`Proxy` çš„ `get` æ‹¦æˆªå™¨ä¼šè§¦å‘ï¼ŒVue ä¼šæ”¶é›†å½“å‰å±æ€§çš„ä¾èµ–ã€‚
   - å½“ä¿®æ”¹å“åº”å¼å¯¹è±¡çš„å±æ€§æ—¶ï¼Œ`Proxy` çš„ `set` æ‹¦æˆªå™¨ä¼šè§¦å‘ï¼ŒVue ä¼šé€šçŸ¥ç›¸å…³ä¾èµ–é¡¹è¿›è¡Œæ›´æ–°ã€‚
2. **ä¾èµ–è¿½è¸ª**ï¼š
   - Vue 3.x é€šè¿‡ä¾èµ–è¿½è¸ªæœºåˆ¶ï¼Œå®ç°äº†æ›´ç²¾ç¡®çš„æ›´æ–°æ§åˆ¶ã€‚åªæœ‰åœ¨å®é™…ä½¿ç”¨çš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šè§¦å‘è§†å›¾æ›´æ–°ï¼Œé¿å…äº†ä¸å¿…è¦çš„æ¸²æŸ“ã€‚
3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - `Proxy` æ”¯æŒç›´æ¥ç›‘å¬æ–°å¢å’Œåˆ é™¤å±æ€§ï¼Œæ— éœ€ç‰¹æ®Š APIã€‚
   - å¯¹æ•°ç»„çš„æ”¯æŒæ›´åŠ å®Œå–„ï¼Œèƒ½å¤ŸåŸç”Ÿç›‘å¬æ•°ç»„çš„å˜åŒ–ã€‚

**ä¼˜åŠ¿**

1. **æ›´é«˜æ•ˆ**ï¼š`Proxy` çš„æ€§èƒ½ä¼˜äº `Object.defineProperty`ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§å‹å¯¹è±¡æ—¶ã€‚
2. **æ›´çµæ´»**ï¼šæ”¯æŒç›‘å¬æ–°å¢å’Œåˆ é™¤å±æ€§ï¼Œæ— éœ€é¢å¤– APIã€‚
3. **æ›´å¼ºå¤§**ï¼šèƒ½å¤ŸåŸç”Ÿç›‘å¬æ•°ç»„çš„å˜åŒ–ï¼Œç®€åŒ–äº†å¼€å‘æµç¨‹ã€‚

| ç‰¹æ€§          | Vue 2.x                           | Vue 3.x                      |
| ------------- | --------------------------------- | ---------------------------- |
| å®ç°æ–¹å¼      | ä½¿ç”¨ `Object.defineProperty`      | ä½¿ç”¨ `Proxy`                 |
| æ·±åº¦ç›‘å¬      | éœ€è¦é€’å½’éå†å¯¹è±¡ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§    | æ— éœ€é€’å½’ï¼Œæ€§èƒ½æ›´ä¼˜           |
| æ–°å¢/åˆ é™¤å±æ€§ | æ— æ³•ç›´æ¥ç›‘å¬ï¼Œéœ€ä½¿ç”¨ `Vue.set` ç­‰ | ç›´æ¥æ”¯æŒï¼Œæ— éœ€é¢å¤– API       |
| æ•°ç»„ç›‘å¬      | éœ€è¦ç‰¹æ®Šå¤„ç†æ•°ç»„æ–¹æ³•              | åŸç”Ÿæ”¯æŒæ•°ç»„ç›‘å¬             |
| æ€§èƒ½          | ç›¸å¯¹è¾ƒä½                          | æ›´é«˜ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§å‹å¯¹è±¡æ—¶ |
| å¼€å‘ä½“éªŒ      | éœ€è¦é¢å¤– API æ”¯æŒ                 | æ›´åŠ ç®€æ´å’Œç›´è§‚               |

# æ‰©å±•ï¼šæ•°æ®åŒå‘ç»‘å®š

`Vue.js` æœ€æ ¸å¿ƒçš„åŠŸèƒ½æœ‰ä¸¤ä¸ªï¼š

- å“åº”å¼çš„æ•°æ®ç»‘å®šç³»ç»Ÿ
- ç»„ä»¶ç³»ç»Ÿ

> ä»€ä¹ˆæ˜¯æ•°æ®åŒå‘ç»‘å®šï¼Ÿ

`Vue` æ˜¯ä¸€ä¸ª `MVVM` æ¡†æ¶ï¼Œå³æ•°æ®åŒå‘ç»‘å®šã€‚å½“æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè§¦å‘è§†å›¾æ›´æ–°ï¼›å½“è§†å›¾å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè§¦å‘æ•°æ®æ›´æ–°ã€‚

> ä¸ºä»€ä¹ˆè¦å®ç°æ•°æ®çš„åŒå‘ç»‘å®šï¼Ÿ

åœ¨ Vue ä¸­ï¼Œå¦‚æœä½¿ç”¨ VueXï¼Œå®é™…ä¸Šæ•°æ®è¿˜æ˜¯å•å‘çš„ï¼Œä¹‹æ‰€ä»¥è¯´æ˜¯æ•°æ®åŒå‘ç»‘å®šï¼Œè¿™æ˜¯ä»ä½¿ç”¨UIæ§ä»¶æ¥è¯´ï¼Œå¯¹äºæˆ‘ä»¬å¤„ç†è¡¨å•ï¼ŒVueçš„åŒå‘æ•°æ®ç»‘å®šç”¨èµ·æ¥å°±ç‰¹åˆ«èˆ’æœäº†ã€‚

å³ä¸¤è€…å¹¶ä¸äº’æ–¥ï¼Œ åœ¨å…¨å±€æ€§æ•°æ®æµä½¿ç”¨å•å‘ï¼Œæ–¹ä¾¿è·Ÿè¸ªï¼› å±€éƒ¨æ€§æ•°æ®æµä½¿ç”¨åŒå‘ï¼Œç®€å•æ˜“æ“ä½œã€‚

## è®¿é—®å™¨å±æ€§

`Object.defineProperty()` å‡½æ•°å¯ä»¥å®šä¹‰å¯¹è±¡çš„å±æ€§ç›¸å…³æè¿°ç¬¦ï¼Œ å…¶ä¸­çš„ `set` å’Œ `get` å‡½æ•°å¯¹äºå®Œæˆæ•°æ®åŒå‘ç»‘å®šèµ·åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ã€‚

```javascript
var obj = {
  foo: 'foo',
};

Object.defineProperty(obj, 'foo', {
  get: function () {
    console.log('å°†è¦è¯»å–obj.fooå±æ€§');
  },
  set: function (newVal) {
    console.log('å½“å‰å€¼ä¸º', newVal);
  },
});

obj.foo; // å°†è¦è¯»å–obj.fooå±æ€§
obj.foo = 'name'; // å½“å‰å€¼ä¸º name
```

å¯ä»¥çœ‹åˆ°ï¼Œ`get` å³ä¸ºæˆ‘ä»¬è®¿é—®å±æ€§æ—¶è°ƒç”¨ï¼Œ`set` ä¸ºæˆ‘ä»¬è®¾ç½®å±æ€§å€¼æ—¶è°ƒç”¨ã€‚

## ç®€å•çš„æ•°æ®åŒå‘ç»‘å®šå®ç°æ–¹æ³•

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ•°æ®åŒå‘ç»‘å®š</title>
  </head>
  <body>
    <form autocomplete="off">
      <label>è¾“å…¥ï¼š</label>
      <input type="text" id="textInput" style="outline: none" />
      <br /><br />
      <label>è¾“å‡ºï¼š</label>
      <span id="textSpan"></span>
    </form>
    <script>
      // -- è·å–DOMå…ƒç´ 
      const textInput = document.getElementById('textInput');
      const textSpan = document.getElementById('textSpan');
      // -- å®šä¹‰æ•°æ®æ¨¡å‹
      const data = { value: 'Hello' };
      textInput.value = data.value;
      textSpan.textContent = data.value;
      // -- æ•°æ®åŠ«æŒ
      Object.defineProperty(data, 'value', {
        set: function (newValue) {
          textInput.value = newValue;
          textSpan.textContent = newValue;
        },
        get: function () {},
      });
      // -- ç›‘å¬ç”¨æˆ·æ“ä½œ
      textInput.addEventListener('input', function ({ target: { value } }) {
        data.value = value;
      });
    </script>
  </body>
</html>
```



![](./IMGS/bindings.gif)

å¯ä»¥çœ‹åˆ°ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„æ•°æ®åŒå‘ç»‘å®šè¿˜æ˜¯ä¸éš¾çš„ï¼š ä½¿ç”¨ `Object.defineProperty()` æ¥å®šä¹‰å±æ€§çš„ `set` å‡½æ•°ï¼Œå±æ€§è¢«èµ‹å€¼çš„æ—¶å€™ï¼Œä¿®æ”¹ `input` çš„ `value` å€¼ä»¥åŠ `span` æ ‡ç­¾çš„ `textContent`ï¼›ç„¶åç›‘å¬ `input` çš„ `input` äº‹ä»¶ï¼Œä¿®æ”¹å¯¹è±¡çš„å±æ€§å€¼ï¼Œå³å¯å®ç°è¿™æ ·çš„ä¸€ä¸ªç®€å•çš„æ•°æ®åŒå‘ç»‘å®šã€‚

## å®ç°ä»»åŠ¡çš„æ€è·¯

ä¸Šé¢æˆ‘ä»¬åªæ˜¯å®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„æ•°æ®åŒå‘ç»‘å®šï¼Œè€Œæˆ‘ä»¬çœŸæ­£å¸Œæœ›å®ç°çš„æ˜¯ä¸‹é¢è¿™ç§æ–¹å¼ï¼š

```vue
<div id="app">
  <input type="text" v-model="message" />
  {{ text }}
</div>

<script>
  var vm = new Vue({
    el: '#app',
    data: {
      message: 'Helloï¼ŒVue.js',
    },
  });
</script>
```

å³å’Œ `Vue` ä¸€æ ·çš„æ–¹å¼æ¥å®ç°æ•°æ®çš„åŒå‘ç»‘å®šã€‚é‚£ä¹ˆï¼Œ**æˆ‘ä»¬å¯ä»¥æŠŠæ•´ä¸ªå®ç°è¿‡ç¨‹åˆ†ä¸ºä¸‹é¢å‡ æ­¥ï¼š **

- è¾“å…¥æ¡†ä»¥åŠæ–‡æœ¬èŠ‚ç‚¹ä¸ `data` ä¸­çš„æ•°æ® **ç»‘å®š**ï¼›
- è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶ï¼Œdata ä¸­çš„æ•°æ®åŒæ­¥å˜åŒ–ï¼Œå³ `view` â†’ `model` çš„å˜åŒ–ï¼›
- `data` ä¸­çš„æ•°æ®å˜åŒ–æ—¶ï¼Œæ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹åŒæ­¥å˜åŒ–ï¼Œå³ `model` â†’ `view` çš„å˜åŒ–ï¼›

## DocumentFragment

å¦‚æœå¸Œæœ›å®ç°ä»»åŠ¡ä¸€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨åˆ° `DocumentFragment` æ–‡æ¡£ç‰‡æ®µï¼Œå¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªå®¹å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```html
<div id="app"></div>
<script>
  const flag = document.createDocumentFragment();
  const span = document.createElement('span');
  const textNode = document.createTextNode('Hello, Vue.js!');
  span.appendChild(textNode);
  flag.append(span);
  document.getElementById('app').appendChild(flag);
</script>
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸‹é¢çš„DOMæ ‘ï¼š

![](./IMGS/dom_tree.PNG)

ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µçš„å¥½å¤„åœ¨äºï¼šåœ¨æ–‡æ¡£ç‰‡æ®µä¸Šè¿›è¡Œæ“ä½œDOMï¼Œè€Œä¸ä¼šå½±å“åˆ°çœŸå®çš„DOMï¼Œæ“ä½œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ·»åŠ åˆ°çœŸå®DOMä¸Šï¼Œè¿™æ ·çš„æ•ˆç‡æ¯”ç›´æ¥åœ¨æ­£å¼DOMä¸Šä¿®æ”¹è¦é«˜å¾ˆå¤š ã€‚

> Tipsï¼š`Vue` è¿›è¡Œç¼–è¯‘æ—¶ï¼Œå°±æ˜¯å°†æŒ‚è½½ç›®æ ‡çš„æ‰€æœ‰å­èŠ‚ç‚¹åŠ«æŒåˆ° `DocumentFragment` ä¸­ï¼Œç»è¿‡ä¸€ç•ªå¤„ç†ä¹‹åï¼Œå†å°† `DocumentFragment` æ•´ä½“è¿”å›æ’å…¥æŒ‚è½½ç›®æ ‡ã€‚

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="app">
      <input type="text" id="a" />
      <span id="b"></span>
    </div>
    <script>
      var dom = nodeToFragment(document.getElementById('app'));
      console.log(dom);
      function nodeToFragment(node) {
        var flag = document.createDocumentFragment();
        var child; 
        while ((child = node.firstChild)) {
          flag.appendChild(child);
        }
        return flag;
      }
      document.getElementById('app').appendChild(dom);
    </script>
  </body>
</html>
```

å³é¦–å…ˆè·å–åˆ° `div`ï¼Œç„¶åé€šè¿‡ `documentFragment` åŠ«æŒï¼Œæ¥ç€å†æŠŠè¿™ä¸ªæ–‡æ¡£ç‰‡æ®µæ·»åŠ åˆ° `div` ä¸Šå»ã€‚



